{% extends "base.html" %}
{% from "macros.html" import forum_post_card, pagination %}

{% block title %}Diễn đàn - VietEnglish{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4 align-items-center">
        <div class="col-lg-8">
            <h1 class="mb-0">
                <i class="fas fa-comments me-2 text-primary"></i>Diễn đàn
            </h1>
            <p class="lead text-muted mt-2">Chia sẻ kinh nghiệm và đặt câu hỏi với cộng đồng học viên</p>
        </div>
        <div class="col-lg-4 text-lg-end">
            <a href="{{ url_for('create_post') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-1"></i> Tạo bài viết mới
            </a>
        </div>
    </div>

    <!-- Categories and Search -->
    <div class="row mb-4">
        <div class="col-md-8 mb-3 mb-md-0">
            <div class="card shadow-sm">
                <div class="card-body py-2">
                    <nav class="nav nav-pills flex-nowrap overflow-auto">
                        <a class="nav-link active" href="{{ url_for('forums') }}">Tất cả</a>
                        {% for category in categories %}
                            <a class="nav-link" href="{{ url_for('forum_category', category_id=category.id) }}">{{ category.name }}</a>
                        {% endfor %}
                    </nav>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Tìm kiếm bài viết..." id="searchPosts">
                <button class="btn btn-primary" type="button" id="searchButton">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Pinned Posts -->
            {% if pinned_posts %}
                <div class="mb-4">
                    <h5 class="mb-3"><i class="fas fa-thumbtack me-2 text-primary"></i>Bài viết ghim</h5>
                    {% for post in pinned_posts %}
                        {{ forum_post_card(post) }}
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- Recent Posts -->
            <div class="mb-4">
                <h5 class="mb-3"><i class="fas fa-clock me-2 text-primary"></i>Bài viết gần đây</h5>
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="dropdown me-2">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-sort me-1"></i> Sắp xếp
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                                        <li><a class="dropdown-item active" href="#"><i class="fas fa-clock me-1"></i> Mới nhất</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-fire me-1"></i> Nổi bật</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-comment me-1"></i> Nhiều bình luận</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-eye me-1"></i> Nhiều lượt xem</a></li>
                                    </ul>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-filter me-1"></i> Lọc
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                                        <li><a class="dropdown-item active" href="#"><i class="fas fa-calendar me-1"></i> Tất cả thời gian</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-calendar-day me-1"></i> Hôm nay</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-calendar-week me-1"></i> Tuần này</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-calendar-alt me-1"></i> Tháng này</a></li>
                                    </ul>
                                </div>
                            </div>
                            <span class="badge bg-primary">{{ recent_posts|length }} bài viết</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        {% if recent_posts %}
                            <div class="list-group list-group-flush">
                                {% for post in recent_posts %}
                                    <div class="list-group-item p-3 forum-post">
                                        <div class="d-flex">
                                            <div class="flex-shrink-0 me-3">
                                                <img src="{{ url_for('static', filename='uploads/' + post.user.avatar) }}" 
                                                    alt="{{ post.user.username }}" class="avatar" style="width: 50px; height: 50px;">
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h5 class="mb-0">
                                                        <a href="{{ url_for('forum_post', post_id=post.id) }}" class="text-decoration-none">
                                                            {% if post.is_pinned %}<i class="fas fa-thumbtack text-primary me-1"></i>{% endif %}
                                                            {{ post.title }}
                                                        </a>
                                                    </h5>
                                                    <span class="badge bg-primary">{{ post.category.name }}</span>
                                                </div>
                                                <p class="text-muted mb-2">{{ post.content|truncate(150) }}</p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="small text-muted">
                                                        <span>Bởi <b>{{ post.user.username }}</b></span>
                                                        <span class="ms-2">{{ post.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                                                    </div>
                                                    <div>
                                                        <span class="me-3"><i class="far fa-eye me-1"></i> {{ post.views }}</span>
                                                        <span><i class="far fa-comment me-1"></i> {{ post.comments|length }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-comments text-muted" style="font-size: 4rem;"></i>
                                <p class="mt-3">Chưa có bài viết nào. Hãy là người đầu tiên chia sẻ!</p>
                            </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-white">
                        {{ pagination(1, 5, 'forums') }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Top Contributors -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-trophy me-2 text-warning"></i>Thành viên tích cực</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-primary rounded-circle">1</span>
                            </div>
                            <img src="{{ url_for('static', filename='uploads/default_avatar.png') }}" 
                                 alt="User 1" class="avatar me-3" style="width: 40px; height: 40px;">
                            <div>
                                <h6 class="mb-0">Nguyễn Văn A</h6>
                                <small class="text-muted">125 bài viết</small>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-secondary rounded-circle">2</span>
                            </div>
                            <img src="{{ url_for('static', filename='uploads/default_avatar.png') }}" 
                                 alt="User 2" class="avatar me-3" style="width: 40px; height: 40px;">
                            <div>
                                <h6 class="mb-0">Trần Thị B</h6>
                                <small class="text-muted">98 bài viết</small>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-secondary rounded-circle">3</span>
                            </div>
                            <img src="{{ url_for('static', filename='uploads/default_avatar.png') }}" 
                                 alt="User 3" class="avatar me-3" style="width: 40px; height: 40px;">
                            <div>
                                <h6 class="mb-0">Lê Văn C</h6>
                                <small class="text-muted">87 bài viết</small>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-secondary rounded-circle">4</span>
                            </div>
                            <img src="{{ url_for('static', filename='uploads/default_avatar.png') }}" 
                                 alt="User 4" class="avatar me-3" style="width: 40px; height: 40px;">
                            <div>
                                <h6 class="mb-0">Phạm Thị D</h6>
                                <small class="text-muted">76 bài viết</small>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-secondary rounded-circle">5</span>
                            </div>
                            <img src="{{ url_for('static', filename='uploads/default_avatar.png') }}" 
                                 alt="User 5" class="avatar me-3" style="width: 40px; height: 40px;">
                            <div>
                                <h6 class="mb-0">Hoàng Văn E</h6>
                                <small class="text-muted">64 bài viết</small>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Forum Categories -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2 text-primary"></i>Danh mục</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for category in categories %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{{ url_for('forum_category', category_id=category.id) }}" class="text-decoration-none">
                                    {{ category.name }}
                                </a>
                                <span class="badge bg-primary rounded-pill">{{ category.posts|length }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            
            <!-- Popular Tags -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tags me-2 text-success"></i>Thẻ phổ biến</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">grammar</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">vocabulary</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">speaking</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">listening</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">writing</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">reading</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">IELTS</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">TOEIC</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">pronunciation</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">learning tips</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">resources</a>
                        <a href="#" class="badge bg-light text-dark text-decoration-none p-2">exam preparation</a>
                    </div>
                </div>
            </div>
            
            <!-- Forum Guidelines -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2 text-info"></i>Quy định diễn đàn</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item px-0">
                            <i class="fas fa-check text-success me-2"></i> Tôn trọng các thành viên khác
                        </li>
                        <li class="list-group-item px-0">
                            <i class="fas fa-check text-success me-2"></i> Không đăng nội dung xúc phạm, phân biệt
                        </li>
                        <li class="list-group-item px-0">
                            <i class="fas fa-check text-success me-2"></i> Không spam hoặc quảng cáo
                        </li>
                        <li class="list-group-item px-0">
                            <i class="fas fa-check text-success me-2"></i> Tìm kiếm trước khi đặt câu hỏi
                        </li>
                        <li class="list-group-item px-0">
                            <i class="fas fa-check text-success me-2"></i> Đăng đúng chủ đề ở đúng danh mục
                        </li>
                    </ul>
                    <a href="#" class="btn btn-outline-info btn-sm mt-3 w-100">
                        <i class="fas fa-book me-1"></i> Xem đầy đủ quy định
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality
        const searchInput = document.getElementById('searchPosts');
        const searchButton = document.getElementById('searchButton');
        const forumPosts = document.querySelectorAll('.forum-post');
        
        function searchPosts() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Show all posts if search term is empty
                forumPosts.forEach(post => {
                    post.style.display = '';
                });
                return;
            }
            
            forumPosts.forEach(post => {
                const title = post.querySelector('h5').textContent.toLowerCase();
                const content = post.querySelector('p').textContent.toLowerCase();
                const username = post.querySelector('.small b').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || content.includes(searchTerm) || username.includes(searchTerm)) {
                    post.style.display = '';
                } else {
                    post.style.display = 'none';
                }
            });
        }
        
        searchButton.addEventListener('click', searchPosts);
        
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchPosts();
            }
        });
        
        // Category navigation
        const categoryLinks = document.querySelectorAll('.nav-pills .nav-link');
        
        categoryLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                categoryLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Forum post hover effect
        forumPosts.forEach(post => {
            post.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            
            post.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });
    });
</script>
{% endblock %}