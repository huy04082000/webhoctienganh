{% extends "base.html" %}
{% from "macros.html" import course_card %}

{% block title %}Khóa học - VietEnglish{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4 align-items-center">
        <div class="col-lg-8">
            <h1 class="mb-0">
                <i class="fas fa-book me-2 text-primary"></i>Khóa học
            </h1>
            <p class="lead text-muted mt-2">Khám phá các khóa học tiếng Anh phù hợp với trình độ của bạn</p>
        </div>
        <div class="col-lg-4">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Tìm kiếm khóa học..." id="searchCourse">
                <button class="btn btn-primary" type="button" id="searchButton">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3 mb-md-0">
                    <label for="levelFilter" class="form-label">Trình độ</label>
                    <select class="form-select" id="levelFilter">
                        <option value="">Tất cả trình độ</option>
                        <option value="Beginner (A1)">Beginner (A1)</option>
                        <option value="Elementary (A2)">Elementary (A2)</option>
                        <option value="Intermediate (B1)">Intermediate (B1)</option>
                        <option value="Upper Intermediate (B2)">Upper Intermediate (B2)</option>
                        <option value="Advanced (C1)">Advanced (C1)</option>
                        <option value="Proficient (C2)">Proficient (C2)</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3 mb-md-0">
                    <label for="topicFilter" class="form-label">Chủ đề</label>
                    <select class="form-select" id="topicFilter">
                        <option value="">Tất cả chủ đề</option>
                        <option value="General English">Tiếng Anh tổng quát</option>
                        <option value="Business English">Tiếng Anh thương mại</option>
                        <option value="Academic English">Tiếng Anh học thuật</option>
                        <option value="IELTS">Luyện thi IELTS</option>
                        <option value="TOEIC">Luyện thi TOEIC</option>
                        <option value="Conversation">Giao tiếp</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3 mb-md-0">
                    <label for="durationFilter" class="form-label">Thời lượng</label>
                    <select class="form-select" id="durationFilter">
                        <option value="">Tất cả thời lượng</option>
                        <option value="4">≤ 4 tuần</option>
                        <option value="8">≤ 8 tuần</option>
                        <option value="12">≤ 12 tuần</option>
                        <option value="16">≤ 16 tuần</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" id="applyFilters">
                        <i class="fas fa-filter me-1"></i> Lọc khóa học
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommended Courses -->
    {% if user_profile and user_profile.language_level %}
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-star text-warning me-2"></i>Khóa học đề xuất cho bạn
            </h2>
        </div>
        
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="recommendedCourses">
            {% for course in recommended_courses %}
                <div class="col course-item" 
                     data-level="{{ course.level }}" 
                     data-topic="{{ course.topic }}" 
                     data-duration="{{ course.duration_weeks }}">
                    {{ course_card(course, enrolled=(course.id in enrolled_course_ids)) }}
                </div>
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Chưa có khóa học được đề xuất cho bạn.
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Beginner Courses -->
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-seedling text-success me-2"></i>Khóa học cho người mới bắt đầu
            </h2>
            <div class="d-none d-md-block">
                <button class="btn btn-outline-primary btn-sm section-toggle" data-section="beginnerCourses">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>
        
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="beginnerCourses">
            {% for course in beginner_courses %}
                <div class="col course-item" 
                     data-level="{{ course.level }}" 
                     data-topic="{{ course.topic }}" 
                     data-duration="{{ course.duration_weeks }}">
                    {{ course_card(course, enrolled=(course.id in enrolled_course_ids)) }}
                </div>
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Chưa có khóa học nào cho trình độ này.
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Intermediate Courses -->
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-chart-line text-primary me-2"></i>Khóa học trình độ trung cấp
            </h2>
            <div class="d-none d-md-block">
                <button class="btn btn-outline-primary btn-sm section-toggle" data-section="intermediateCourses">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>
        
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="intermediateCourses">
            {% for course in intermediate_courses %}
                <div class="col course-item" 
                     data-level="{{ course.level }}" 
                     data-topic="{{ course.topic }}" 
                     data-duration="{{ course.duration_weeks }}">
                    {{ course_card(course, enrolled=(course.id in enrolled_course_ids)) }}
                </div>
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Chưa có khóa học nào cho trình độ này.
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Advanced Courses -->
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-graduation-cap text-danger me-2"></i>Khóa học nâng cao
            </h2>
            <div class="d-none d-md-block">
                <button class="btn btn-outline-primary btn-sm section-toggle" data-section="advancedCourses">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>
        
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="advancedCourses">
            {% for course in advanced_courses %}
                <div class="col course-item" 
                     data-level="{{ course.level }}" 
                     data-topic="{{ course.topic }}" 
                     data-duration="{{ course.duration_weeks }}">
                    {{ course_card(course, enrolled=(course.id in enrolled_course_ids)) }}
                </div>
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Chưa có khóa học nào cho trình độ này.
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle sections
        const sectionToggles = document.querySelectorAll('.section-toggle');
        sectionToggles.forEach(toggle => {
            toggle.addEventListener('click', function() {
                const sectionId = this.getAttribute('data-section');
                const section = document.getElementById(sectionId);
                
                if (section.classList.contains('d-none')) {
                    section.classList.remove('d-none');
                    this.querySelector('i').classList.remove('fa-chevron-down');
                    this.querySelector('i').classList.add('fa-chevron-up');
                } else {
                    section.classList.add('d-none');
                    this.querySelector('i').classList.remove('fa-chevron-up');
                    this.querySelector('i').classList.add('fa-chevron-down');
                }
            });
        });
        
        // Filter and search
        const applyFiltersButton = document.getElementById('applyFilters');
        const searchButton = document.getElementById('searchButton');
        const searchInput = document.getElementById('searchCourse');
        
        function filterCourses() {
            const levelFilter = document.getElementById('levelFilter').value;
            const topicFilter = document.getElementById('topicFilter').value;
            const durationFilter = document.getElementById('durationFilter').value;
            const searchTerm = searchInput.value.toLowerCase();
            
            const courseItems = document.querySelectorAll('.course-item');
            
            courseItems.forEach(item => {
                const level = item.getAttribute('data-level');
                const topic = item.getAttribute('data-topic');
                const duration = item.getAttribute('data-duration');
                const title = item.querySelector('.card-title').textContent.toLowerCase();
                const description = item.querySelector('.card-text').textContent.toLowerCase();
                
                // Check if the course matches all filters
                const matchesLevel = !levelFilter || level === levelFilter;
                const matchesTopic = !topicFilter || topic === topicFilter;
                const matchesDuration = !durationFilter || parseInt(duration) <= parseInt(durationFilter);
                const matchesSearch = !searchTerm || 
                                    title.includes(searchTerm) || 
                                    description.includes(searchTerm);
                
                // Show/hide based on filter matches
                if (matchesLevel && matchesTopic && matchesDuration && matchesSearch) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Check if any sections are empty after filtering
            checkEmptySections();
        }
        
        function checkEmptySections() {
            const sections = ['recommendedCourses', 'beginnerCourses', 'intermediateCourses', 'advancedCourses'];
            
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (!section) return;
                
                const visibleCourses = section.querySelectorAll('.course-item[style=""]');
                const emptyMessage = section.querySelector('.alert');
                
                if (visibleCourses.length === 0) {
                    if (!emptyMessage) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'col-12';
                        alertDiv.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Không tìm thấy khóa học phù hợp với bộ lọc.
                            </div>
                        `;
                        section.appendChild(alertDiv);
                    }
                } else {
                    if (emptyMessage) {
                        emptyMessage.closest('.col-12').remove();
                    }
                }
            });
        }
        
        // Attach event listeners
        applyFiltersButton.addEventListener('click', filterCourses);
        
        searchButton.addEventListener('click', filterCourses);
        
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                filterCourses();
            }
        });
        
        // Add animation to course cards
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-10px)';
                this.style.transition = 'transform 0.3s ease';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    });
</script>
{% endblock %}